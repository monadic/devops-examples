#!/bin/bash

# Create base ConfigHub units for drift-detector deployment
# This follows the global-app pattern where ALL configuration is managed through ConfigHub

set -e

# CRITICAL: Clean up old resources first (cleanup-first principle)
echo "ðŸ§¹ Cleaning up old resources before setup..."

# Clean up Kubernetes resources
if kubectl get namespace drift-test &>/dev/null; then
    echo "  Deleting drift-test namespace..."
    kubectl delete namespace drift-test --wait=false 2>/dev/null || true
fi

# Clean up any existing .cub-project file
if [ -e ".cub-project" ]; then
    OLD_PROJECT=$(cat .cub-project)
    echo "  Found existing project: $OLD_PROJECT"
    echo "  Cleaning up old ConfigHub spaces..."

    # Delete old spaces
    cub space delete $OLD_PROJECT 2>/dev/null || true
    cub space delete $OLD_PROJECT-base 2>/dev/null || true
    cub space delete $OLD_PROJECT-filters 2>/dev/null || true
    cub space delete $OLD_PROJECT-dev 2>/dev/null || true
    cub space delete $OLD_PROJECT-staging 2>/dev/null || true
    cub space delete $OLD_PROJECT-prod 2>/dev/null || true

    rm -f .cub-project
    echo "  âœ… Cleanup complete"
fi

# Generate or use provided project prefix
if [ -z "$1" ]; then
  # Generate a new unique prefix using ConfigHub (like "chubby-paws")
  prefix=$(cub space new-prefix)
  project="${prefix}-drift-detector"
  echo "Generated project name: $project"
else
  project=$1
fi

# Save the project name for future use
echo $project > .cub-project

echo "ðŸš€ Setting up ConfigHub spaces and units for drift-detector..."

# Create main space for drift-detector
echo "Creating space: $project"
cub space create $project --label project=$project --label app=drift-detector

# Create filters space
echo "Creating filters space: $project-filters"
cub space create $project-filters --label project=$project --label type=filters

# Create filters for targeting
echo "Creating filters..."
cub filter create all   Unit --where-field "Space.Labels.project = '$project'" --space $project-filters || true
cub filter create devops-apps Unit --where-field "Labels.type='devops-app'" --space $project-filters || true
cub filter create critical Unit --where-field "Labels.tier='critical'" --space $project-filters || true
cub filter create drift-detector Unit --where-field "Labels.app='drift-detector'" --space $project-filters || true

# Create base space for base configurations
echo "Creating base space: $project-base"
cub space create $project-base --label base=true --label project=$project

# Create units from base configurations
echo "Loading base configurations as units..."

# Namespace unit
cub unit create namespace confighub/base/namespace.yaml \
  --space $project-base \
  --label type=infrastructure \
  --label tier=critical || true

# RBAC unit
cub unit create drift-detector-rbac confighub/base/drift-detector-rbac.yaml \
  --space $project-base \
  --label type=devops-app \
  --label app=drift-detector \
  --label tier=critical || true

# Deployment unit
cub unit create drift-detector-deployment confighub/base/drift-detector-deployment.yaml \
  --space $project-base \
  --label type=devops-app \
  --label app=drift-detector \
  --label tier=critical || true

# Service unit
cub unit create drift-detector-service confighub/base/drift-detector-service.yaml \
  --space $project-base \
  --label type=devops-app \
  --label app=drift-detector \
  --label tier=critical || true

# Create Sets for grouping
echo "Creating sets for grouped operations..."
cub set create devops-apps-set \
  --space $project \
  --label tier=critical \
  --label type=devops-app || true

cub set create drift-detector-set \
  --space $project \
  --label app=drift-detector \
  --label tier=critical || true

echo "âœ… Base setup complete!"
echo ""
echo "Next steps:"
echo "1. Run: bin/setup-worker    # Create and install ConfigHub worker"
echo "2. Run: bin/apply-base      # Deploy units to Kubernetes"
echo "3. Run: bin/test-workflow   # Validate the complete workflow"
echo ""
echo "ðŸ“š For a complete guide, see QUICKSTART.md"
echo ""
echo "To view the ConfigHub structure:"
echo "  cub unit list --space $project-base"
echo ""
echo "You should see:"
echo "  NAME                         SPACE                           STATUS"
echo "  namespace                    $project-base                   NoLive"
echo "  drift-detector-rbac          $project-base                   NoLive"
echo "  drift-detector-deployment    $project-base                   NoLive"
echo "  drift-detector-service       $project-base                   NoLive"
echo ""
echo "STATUS=NoLive means units exist but haven't been deployed yet."