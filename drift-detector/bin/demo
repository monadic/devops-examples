#!/bin/bash
# Interactive demo script for drift-detector
# Shows the full workflow without needing real infrastructure

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

clear

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}     ğŸš€ Drift Detector - Interactive Demo ğŸš€${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "This demo shows how the Drift Detector works without"
echo "requiring real ConfigHub or Kubernetes infrastructure."
echo ""
echo -e "${YELLOW}Press Enter to continue...${NC}"
read

clear

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸ“‹ Step 1: The Problem - Configuration Drift${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "Configuration drift happens when:"
echo "  â€¢ Someone manually scales a deployment"
echo "  â€¢ A hotfix is applied directly to production"
echo "  â€¢ Auto-scaling changes replica counts"
echo "  â€¢ Emergency changes bypass normal processes"
echo ""
echo "Example drift:"
echo -e "${RED}  âš ï¸  backend-api: Running 10 replicas (expected: 3)${NC}"
echo -e "${RED}  âš ï¸  frontend-web: Running 1 replica (expected: 2)${NC}"
echo ""
echo -e "${YELLOW}Press Enter to see the solution...${NC}"
read

clear

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸ”§ Step 2: The Solution - DevOps as Apps${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "Instead of ephemeral workflows (like Cased.com), we build"
echo "persistent applications that:"
echo ""
echo "  âœ… Run continuously (not triggered)"
echo "  âœ… Use event-driven architecture (informers)"
echo "  âœ… Leverage ConfigHub's real features"
echo "  âœ… Include AI analysis (Claude)"
echo "  âœ… Fix issues automatically"
echo ""
echo -e "${YELLOW}Press Enter to run the drift detector...${NC}"
read

clear

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸš€ Step 3: Running Drift Detector (Demo Mode)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Build if needed
if [ ! -f "./drift-detector" ]; then
    echo "Building drift-detector..."
    go build .
fi

# Run demo mode with output
./drift-detector demo 2>&1 | while IFS= read -r line; do
    # Color code the output
    if [[ $line == *"âœ…"* ]]; then
        echo -e "${GREEN}$line${NC}"
    elif [[ $line == *"âš ï¸"* ]]; then
        echo -e "${YELLOW}$line${NC}"
    elif [[ $line == *"âŒ"* ]]; then
        echo -e "${RED}$line${NC}"
    elif [[ $line == *"ğŸ¤–"* ]]; then
        echo -e "${CYAN}$line${NC}"
    elif [[ $line == *"Step"* ]]; then
        echo -e "${BLUE}$line${NC}"
    else
        echo "$line"
    fi
done

echo ""
echo -e "${YELLOW}Press Enter to see ConfigHub features used...${NC}"
read

clear

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸ“Š Step 4: ConfigHub Features Demonstrated${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${GREEN}REAL ConfigHub Features Used:${NC}"
echo "  âœ… Spaces - Organized configuration"
echo "  âœ… Sets - Grouped critical services"
echo "  âœ… Filters - Targeted resources with WHERE clauses"
echo "  âœ… Push-upgrade - BulkPatchUnits(Upgrade: true)"
echo "  âœ… Live State - Read deployment status"
echo ""
echo -e "${RED}Hallucinated Features Avoided:${NC}"
echo "  âŒ Variants (don't exist)"
echo "  âŒ Gates (don't exist)"
echo "  âŒ Dependency graphs (don't exist)"
echo "  âŒ UpdateStatus (can't update live state)"
echo ""
echo -e "${YELLOW}Press Enter to see deployment options...${NC}"
read

clear

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸŒ Step 5: Deployment Options${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${GREEN}Development Mode:${NC}"
echo "  ConfigHub â†’ Kubernetes (direct)"
echo "  â€¢ Fast feedback loops"
echo "  â€¢ No Git intermediary"
echo "  â€¢ Perfect for testing"
echo ""
echo -e "${CYAN}Enterprise Mode:${NC}"
echo "  ConfigHub â†’ Git â†’ Flux/Argo â†’ Kubernetes"
echo "  â€¢ Full audit trail"
echo "  â€¢ Compliance friendly"
echo "  â€¢ Production ready"
echo ""
echo -e "${YELLOW}Press Enter for next steps...${NC}"
read

clear

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}ğŸ¯ Next Steps${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "1. ${GREEN}Test with real ConfigHub:${NC}"
echo "   cub auth login"
echo "   ./bin/install"
echo ""
echo "2. ${GREEN}Test with Kind cluster:${NC}"
echo "   ./bin/create-cluster"
echo "   ./bin/deploy-test --with-drift"
echo "   ./drift-detector"
echo ""
echo "3. ${GREEN}Deploy to production:${NC}"
echo "   ./bin/deploy-prod"
echo ""
echo "4. ${GREEN}Build other DevOps apps:${NC}"
echo "   â€¢ Cost Optimizer"
echo "   â€¢ Security Scanner"
echo "   â€¢ Compliance Auditor"
echo "   â€¢ Upgrade Manager"
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ¨ Demo Complete! âœ¨${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "Learn more:"
echo "  â€¢ README.md - Full documentation"
echo "  â€¢ docs/DEVOPS-AS-APPS-PLAN.md - Architecture"
echo "  â€¢ https://github.com/monadic/devops-examples"